<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Three-Chamber Vapor Extraction Simulator</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #050712;
      --panel: rgba(13, 25, 46, 0.85);
      --panel-border: rgba(103, 232, 249, 0.18);
      --accent: #22d3ee;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --oil: #f97316;
      --water: #38bdf8;
      --steam: #a855f7;
      --extract: #facc15;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(30, 64, 175, 0.35), rgba(2, 6, 23, 0.95)), var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 2.5rem 1.5rem 4rem;
    }

    .app {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    h1 {
      margin: 0 0 0.35rem;
      font-size: clamp(2rem, 3vw, 2.75rem);
      letter-spacing: 0.02em;
    }

    p.lead {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1.5rem;
    }

    @media (min-width: 1080px) {
      .layout {
        grid-template-columns: minmax(0, 2.4fr) minmax(0, 1fr);
        align-items: start;
      }
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 18px;
      padding: clamp(1rem, 2.5vw, 1.5rem);
      box-shadow: 0 18px 55px rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(18px);
    }

    canvas {
      width: 100%;
      height: clamp(320px, 55vh, 480px);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      background: #020617;
      display: block;
    }

    .status-bar,
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.25rem;
      align-items: center;
      margin-top: 1rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.18);
      color: #e0f2fe;
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }

    button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.1rem;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      color: #0f172a;
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.25), rgba(14, 165, 233, 0.75));
      border: 1px solid rgba(125, 211, 252, 0.45);
      box-shadow: 0 12px 25px rgba(14, 116, 144, 0.25);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(14, 116, 144, 0.35);
    }

    button.secondary {
      background: rgba(71, 85, 105, 0.35);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: none;
    }

    .legend {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1.25rem;
      font-size: 0.88rem;
    }

    .legend h3 {
      margin: 0 0 0.65rem;
      font-size: 1rem;
      letter-spacing: 0.04em;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 1.25rem;
    }

    .metric-card {
      padding: 0.85rem 1rem;
      border-radius: 14px;
      border: 1px solid rgba(125, 211, 252, 0.12);
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .metric-label {
      color: var(--muted);
      font-size: 0.78rem;
      letter-spacing: 0.02em;
    }

    .metric-value {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .legend-diagram {
      margin-top: 1.5rem;
      padding: 1rem 1.2rem;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.5);
      font-family: "Fira Code", "Source Code Pro", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.8rem;
      line-height: 1.4;
      color: rgba(203, 213, 225, 0.85);
      white-space: pre;
    }

    .error {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: #fecaca;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Three-Chamber Vapor Extraction Simulator</h1>
      <p class="lead">Steam-assisted distillation of essential oils across coupled oil heating, water percolation, and vapor separation chambers.</p>
    </header>

    <div class="layout">
      <section class="panel" aria-labelledby="sim-heading">
        <div class="status-bar">
          <span class="status-pill" id="temp-pill">üå°Ô∏è Oil Bath 393&nbsp;K</span>
          <span class="status-pill" id="water-pill">üíß Water Bath 373&nbsp;K</span>
          <span class="status-pill" id="pressure-pill">üåÄ Suction 80&nbsp;kPa</span>
          <span class="status-pill" id="time-pill">‚è±Ô∏è Time 0.000&nbsp;s</span>
        </div>

        <canvas id="sim-canvas" width="960" height="540" role="presentation"></canvas>

        <div class="controls" role="toolbar" aria-label="Simulation controls">
          <button id="run-toggle" type="button">‚ñ∂Ô∏è Run</button>
          <button id="reset" type="button" class="secondary">üîÑ Reset</button>
          <span class="metric-label" id="status-text">Status: idle</span>
        </div>

        <div class="metrics" aria-live="polite">
          <div class="metric-card">
            <span class="metric-label">Oil Volume Fraction</span>
            <span class="metric-value" id="metric-oil">0.00</span>
          </div>
          <div class="metric-card">
            <span class="metric-label">Water Volume Fraction</span>
            <span class="metric-value" id="metric-water">0.00</span>
          </div>
          <div class="metric-card">
            <span class="metric-label">Vapor Volume Fraction</span>
            <span class="metric-value" id="metric-vapor">0.00</span>
          </div>
          <div class="metric-card">
            <span class="metric-label">Extract Flux</span>
            <span class="metric-value" id="metric-extract">0.000</span>
          </div>
        </div>

        <div id="error" class="error" style="display: none;" role="alert"></div>
      </section>

      <aside class="panel">
        <h2 style="margin-top:0;margin-bottom:0.75rem;font-size:1.25rem;letter-spacing:0.03em;">Process Flow &amp; Legend</h2>
        <div class="legend">
          <div>
            <h3>Chamber I</h3>
            <div class="legend-item"><span class="legend-swatch" style="background: var(--oil);"></span> Heats the oil feed, nucleating vapor bubbles.</div>
            <div class="legend-item"><span class="legend-swatch" style="background: #fb923c;"></span> Vapor-rich plumes driven upward.</div>
          </div>
          <div>
            <h3>Chamber II</h3>
            <div class="legend-item"><span class="legend-swatch" style="background: var(--water);"></span> Counter-flowing water bath percolates vapor.</div>
            <div class="legend-item"><span class="legend-swatch" style="background: #a855f7;"></span> Steam entrains oil as droplets.</div>
          </div>
          <div>
            <h3>Chamber III</h3>
            <div class="legend-item"><span class="legend-swatch" style="background: var(--extract);"></span> Condenser separates vapor into extract.</div>
            <div class="legend-item"><span class="legend-swatch" style="background: #fef08a;"></span> Solvent-rich condensate for collection.</div>
          </div>
        </div>
        <div class="legend-diagram" aria-hidden="true">
Oil Input  ‚Üí  [ Heat ]  ‚Üí  Vapor Lift ‚îê
                                   ‚îÇ
Water In   ‚Üí  [ Percolate ]  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ
Steam + Oil  ‚Üí  [ Separate ]  ‚Üí  Extract
        </div>
        <p class="lead" style="margin-top:1.25rem;font-size:0.9rem;line-height:1.6;">
          The schematic shows three spherical chambers linked by tapered tubing. Colours represent volume fractions:
          warm orange for oil, cyan for water, violet for steam, and amber for collected extract. Flow speed is hinted by streaked gradients along the connector tubes.
        </p>
      </aside>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      var chamber1_nx = 60;
      var chamber1_ny = 40;
      var chamber2_nx = 80;
      var chamber2_ny = 60;
      var chamber3_nx = 50;
      var chamber3_ny = 30;

      var params = {
        inputTemp: 393.15,
        waterTemp: 373.15,
        exitTemp: 323.15,
        oilFlowRate: 0.001,
        waterFlowRate: 0.01,
        suctionPressure: 80000,
        heatInput: 75000,
        dt: 0.001,
        interfaceTension: 0.025,
        percolationRate: 0.8
      };

      var state = {
        chambers: null,
        flowRates: { oil: 0, water: 0, vapor: 0, extract: 0 },
        time: 0,
        running: false,
        tickHandle: null,
        error: null
      };

      var canvas = document.getElementById('sim-canvas');
      var ctx = canvas.getContext('2d');
      var runBtn = document.getElementById('run-toggle');
      var resetBtn = document.getElementById('reset');
      var statusText = document.getElementById('status-text');
      var errorEl = document.getElementById('error');

      var metricOil = document.getElementById('metric-oil');
      var metricWater = document.getElementById('metric-water');
      var metricVapor = document.getElementById('metric-vapor');
      var metricExtract = document.getElementById('metric-extract');

      var timePill = document.getElementById('time-pill');
      var tempPill = document.getElementById('temp-pill');
      var waterPill = document.getElementById('water-pill');
      var pressurePill = document.getElementById('pressure-pill');

      if (!ctx) {
        showError('Canvas 2D context is unavailable in this browser. Please update Safari or try another device.');
        return;
      }

      function createFloatArray(size) {
        return new Float32Array(size);
      }

      function createInitialChambers() {
        var chambers = {
          chamber1: {
            temperature: createFloatArray(chamber1_nx * chamber1_ny),
            pressure: createFloatArray(chamber1_nx * chamber1_ny),
            oilDensity: createFloatArray(chamber1_nx * chamber1_ny),
            vaporDensity: createFloatArray(chamber1_nx * chamber1_ny),
            vof_oil: createFloatArray(chamber1_nx * chamber1_ny),
            vof_vapor: createFloatArray(chamber1_nx * chamber1_ny),
            velocityU: createFloatArray(chamber1_nx * chamber1_ny),
            velocityV: createFloatArray(chamber1_nx * chamber1_ny),
            nucleationRate: createFloatArray(chamber1_nx * chamber1_ny),
            nx: chamber1_nx,
            ny: chamber1_ny
          },
          chamber2: {
            temperature: createFloatArray(chamber2_nx * chamber2_ny),
            pressure: createFloatArray(chamber2_nx * chamber2_ny),
            waterDensity: createFloatArray(chamber2_nx * chamber2_ny),
            oilDensity: createFloatArray(chamber2_nx * chamber2_ny),
            steamDensity: createFloatArray(chamber2_nx * chamber2_ny),
            vof_water: createFloatArray(chamber2_nx * chamber2_ny),
            vof_oil: createFloatArray(chamber2_nx * chamber2_ny),
            vof_steam: createFloatArray(chamber2_nx * chamber2_ny),
            velocityU: createFloatArray(chamber2_nx * chamber2_ny),
            velocityV: createFloatArray(chamber2_nx * chamber2_ny),
            interface_oil_water: createFloatArray(chamber2_nx * chamber2_ny),
            massTransfer: createFloatArray(chamber2_nx * chamber2_ny),
            nx: chamber2_nx,
            ny: chamber2_ny
          },
          chamber3: {
            temperature: createFloatArray(chamber3_nx * chamber3_ny),
            pressure: createFloatArray(chamber3_nx * chamber3_ny),
            vaporDensity: createFloatArray(chamber3_nx * chamber3_ny),
            condensateDensity: createFloatArray(chamber3_nx * chamber3_ny),
            oilConcentration: createFloatArray(chamber3_nx * chamber3_ny),
            vof_vapor: createFloatArray(chamber3_nx * chamber3_ny),
            vof_condensate: createFloatArray(chamber3_nx * chamber3_ny),
            velocityU: createFloatArray(chamber3_nx * chamber3_ny),
            velocityV: createFloatArray(chamber3_nx * chamber3_ny),
            extractionRate: createFloatArray(chamber3_nx * chamber3_ny),
            nx: chamber3_nx,
            ny: chamber3_ny
          }
        };

        var i, j, idx, x, y;

        for (i = 0; i < chamber1_nx; i++) {
          for (j = 0; j < chamber1_ny; j++) {
            idx = i + j * chamber1_nx;
            y = j / chamber1_ny;
            chambers.chamber1.temperature[idx] = params.inputTemp - 30 * y;
            chambers.chamber1.pressure[idx] = 101325 - 1000 * y;
            chambers.chamber1.vof_oil[idx] = y < 0.6 ? 0.9 - y * 0.5 : 0.1;
            chambers.chamber1.vof_vapor[idx] = 1 - chambers.chamber1.vof_oil[idx];
            chambers.chamber1.oilDensity[idx] = 850 * chambers.chamber1.vof_oil[idx];
            chambers.chamber1.vaporDensity[idx] = 2.0 * chambers.chamber1.vof_vapor[idx];
            chambers.chamber1.velocityV[idx] = 0.5 * chambers.chamber1.vof_vapor[idx];
            if (j < 5 && Math.random() < 0.05) {
              chambers.chamber1.nucleationRate[idx] = 1.0;
            }
          }
        }

        for (i = 0; i < chamber2_nx; i++) {
          for (j = 0; j < chamber2_ny; j++) {
            idx = i + j * chamber2_nx;
            x = i / chamber2_nx;
            y = j / chamber2_ny;
            chambers.chamber2.temperature[idx] = params.waterTemp + 10 * (0.5 - Math.abs(y - 0.5));
            chambers.chamber2.pressure[idx] = 101325 + 2000 * (0.5 - y);
            if (x < 0.2 && y > 0.7) {
              chambers.chamber2.vof_water[idx] = 0.8;
              chambers.chamber2.vof_steam[idx] = 0.2;
              chambers.chamber2.velocityV[idx] = -0.3;
            } else if (x < 0.1) {
              chambers.chamber2.vof_oil[idx] = 0.3;
              chambers.chamber2.vof_steam[idx] = 0.7;
              chambers.chamber2.velocityU[idx] = 0.4;
            } else {
              chambers.chamber2.vof_water[idx] = 0.4 * (1 - x);
              chambers.chamber2.vof_oil[idx] = 0.2 * x;
              chambers.chamber2.vof_steam[idx] = 1 - chambers.chamber2.vof_water[idx] - chambers.chamber2.vof_oil[idx];
            }
            chambers.chamber2.waterDensity[idx] = 1000 * chambers.chamber2.vof_water[idx];
            chambers.chamber2.oilDensity[idx] = 850 * chambers.chamber2.vof_oil[idx];
            chambers.chamber2.steamDensity[idx] = 0.8 * chambers.chamber2.vof_steam[idx];
            var oilGrad = Math.abs(chambers.chamber2.vof_oil[idx] - chambers.chamber2.vof_water[idx]);
            chambers.chamber2.interface_oil_water[idx] = oilGrad > 0.1 ? 1.0 : 0.0;
          }
        }

        for (i = 0; i < chamber3_nx; i++) {
          for (j = 0; j < chamber3_ny; j++) {
            idx = i + j * chamber3_nx;
            x = i / chamber3_nx;
            y = j / chamber3_ny;
            chambers.chamber3.temperature[idx] = params.exitTemp + 50 * (1 - y);
            chambers.chamber3.pressure[idx] = params.suctionPressure + 5000 * y;
            if (x < 0.2) {
              chambers.chamber3.vof_vapor[idx] = 0.9;
              chambers.chamber3.oilConcentration[idx] = 0.15;
              chambers.chamber3.velocityU[idx] = 0.6;
            } else {
              chambers.chamber3.vof_vapor[idx] = 0.7 * (1 - x) * y;
              chambers.chamber3.vof_condensate[idx] = 1 - chambers.chamber3.vof_vapor[idx];
              chambers.chamber3.oilConcentration[idx] = 0.08 + 0.1 * chambers.chamber3.vof_condensate[idx];
            }
            chambers.chamber3.vaporDensity[idx] = 1.2 * chambers.chamber3.vof_vapor[idx];
            chambers.chamber3.condensateDensity[idx] = 900 * chambers.chamber3.vof_condensate[idx];
            if (x > 0.8) {
              chambers.chamber3.velocityU[idx] = 1.0;
              chambers.chamber3.extractionRate[idx] = chambers.chamber3.oilConcentration[idx];
            }
          }
        }

        return chambers;
      }

      function cloneFloat32Array(array) {
        return new Float32Array(array);
      }

      function cloneChambers(source) {
        return {
          chamber1: {
            temperature: cloneFloat32Array(source.chamber1.temperature),
            pressure: cloneFloat32Array(source.chamber1.pressure),
            oilDensity: cloneFloat32Array(source.chamber1.oilDensity),
            vaporDensity: cloneFloat32Array(source.chamber1.vaporDensity),
            vof_oil: cloneFloat32Array(source.chamber1.vof_oil),
            vof_vapor: cloneFloat32Array(source.chamber1.vof_vapor),
            velocityU: cloneFloat32Array(source.chamber1.velocityU),
            velocityV: cloneFloat32Array(source.chamber1.velocityV),
            nucleationRate: cloneFloat32Array(source.chamber1.nucleationRate),
            nx: source.chamber1.nx,
            ny: source.chamber1.ny
          },
          chamber2: {
            temperature: cloneFloat32Array(source.chamber2.temperature),
            pressure: cloneFloat32Array(source.chamber2.pressure),
            waterDensity: cloneFloat32Array(source.chamber2.waterDensity),
            oilDensity: cloneFloat32Array(source.chamber2.oilDensity),
            steamDensity: cloneFloat32Array(source.chamber2.steamDensity),
            vof_water: cloneFloat32Array(source.chamber2.vof_water),
            vof_oil: cloneFloat32Array(source.chamber2.vof_oil),
            vof_steam: cloneFloat32Array(source.chamber2.vof_steam),
            velocityU: cloneFloat32Array(source.chamber2.velocityU),
            velocityV: cloneFloat32Array(source.chamber2.velocityV),
            interface_oil_water: cloneFloat32Array(source.chamber2.interface_oil_water),
            massTransfer: cloneFloat32Array(source.chamber2.massTransfer),
            nx: source.chamber2.nx,
            ny: source.chamber2.ny
          },
          chamber3: {
            temperature: cloneFloat32Array(source.chamber3.temperature),
            pressure: cloneFloat32Array(source.chamber3.pressure),
            vaporDensity: cloneFloat32Array(source.chamber3.vaporDensity),
            condensateDensity: cloneFloat32Array(source.chamber3.condensateDensity),
            oilConcentration: cloneFloat32Array(source.chamber3.oilConcentration),
            vof_vapor: cloneFloat32Array(source.chamber3.vof_vapor),
            vof_condensate: cloneFloat32Array(source.chamber3.vof_condensate),
            velocityU: cloneFloat32Array(source.chamber3.velocityU),
            velocityV: cloneFloat32Array(source.chamber3.velocityV),
            extractionRate: cloneFloat32Array(source.chamber3.extractionRate),
            nx: source.chamber3.nx,
            ny: source.chamber3.ny
          }
        };
      }

      function calculateSteamDistillation(T, P, oil_vof, water_vof) {
        if (oil_vof < 0.1 || water_vof < 0.1) {
          return 0;
        }
        var vapor_pressure_oil = 5000 * Math.exp(4000 * (1 / 373 - 1 / T));
        var vapor_pressure_water = 101325 * Math.exp(6.8 * (1 - 373 / T));
        var total_vapor_pressure = vapor_pressure_oil + vapor_pressure_water;
        var driving_force = Math.max(0, total_vapor_pressure - P);
        var k_mass = 0.001 * params.percolationRate;
        return k_mass * driving_force * oil_vof * water_vof;
      }

      function updateSimulation() {
        if (!state.chambers) {
          return;
        }

        var chambers = state.chambers;
        var next = cloneChambers(chambers);
        var i, j, idx, T, oil_vof, water_vof, P, vapor_vof, oil_conc, rho;

        for (i = 1; i < chamber1_nx - 1; i++) {
          for (j = 1; j < chamber1_ny - 1; j++) {
            idx = i + j * chamber1_nx;
            T = chambers.chamber1.temperature[idx];
            oil_vof = chambers.chamber1.vof_oil[idx];
            var d2T = (chambers.chamber1.temperature[idx + 1] + chambers.chamber1.temperature[idx - 1] - 2 * T) * (chamber1_nx * chamber1_nx) +
              (chambers.chamber1.temperature[idx + chamber1_nx] + chambers.chamber1.temperature[idx - chamber1_nx] - 2 * T) * (chamber1_ny * chamber1_ny);
            var alpha = 1e-6;
            next.chamber1.temperature[idx] = T + alpha * d2T * params.dt;
            if (j === 0) {
              next.chamber1.temperature[idx] = params.inputTemp;
            }
            if (T > 450 && oil_vof > 0.1) {
              var vaporization_rate = 0.01 * (T - 450) / 100;
              next.chamber1.vof_oil[idx] = Math.max(0, oil_vof - vaporization_rate * params.dt);
              next.chamber1.vof_vapor[idx] = Math.min(1, chambers.chamber1.vof_vapor[idx] + vaporization_rate * params.dt);
              next.chamber1.temperature[idx] -= vaporization_rate * 300000 * params.dt / 4186;
            }
            rho = chambers.chamber1.oilDensity[idx] + chambers.chamber1.vaporDensity[idx];
            if (rho < 400) {
              next.chamber1.velocityV[idx] = Math.min(1.0, chambers.chamber1.velocityV[idx] + 0.1 * params.dt);
            }
          }
        }

        for (i = 1; i < chamber2_nx - 1; i++) {
          for (j = 1; j < chamber2_ny - 1; j++) {
            idx = i + j * chamber2_nx;
            T = chambers.chamber2.temperature[idx];
            P = chambers.chamber2.pressure[idx];
            oil_vof = chambers.chamber2.vof_oil[idx];
            water_vof = chambers.chamber2.vof_water[idx];
            if (chambers.chamber2.interface_oil_water[idx] > 0.5) {
              var mass_transfer = calculateSteamDistillation(T, P, oil_vof, water_vof);
              var oil_to_steam = mass_transfer * params.dt;
              next.chamber2.vof_oil[idx] = Math.max(0, oil_vof - oil_to_steam);
              next.chamber2.vof_steam[idx] = Math.min(1, chambers.chamber2.vof_steam[idx] + oil_to_steam * 2);
              next.chamber2.massTransfer[idx] = mass_transfer;
            }
            if (i < chamber2_nx * 0.3 && j > chamber2_ny * 0.8) {
              next.chamber2.vof_water[idx] = 0.9;
              next.chamber2.velocityV[idx] = -0.5;
            }
            if (i < 5) {
              var vapor_input = 0.3 * (1 - j / chamber2_ny);
              next.chamber2.vof_oil[idx] = Math.min(0.8, chambers.chamber2.vof_oil[idx] + vapor_input * params.dt);
            }
          }
        }

        for (i = 1; i < chamber3_nx - 1; i++) {
          for (j = 1; j < chamber3_ny - 1; j++) {
            idx = i + j * chamber3_nx;
            T = chambers.chamber3.temperature[idx];
            vapor_vof = chambers.chamber3.vof_vapor[idx];
            oil_conc = chambers.chamber3.oilConcentration[idx];
            if (T < 350 && vapor_vof > 0.1) {
              var condensation_rate = 0.02 * vapor_vof * (350 - T) / 50;
              next.chamber3.vof_vapor[idx] = Math.max(0, vapor_vof - condensation_rate * params.dt);
              next.chamber3.vof_condensate[idx] = Math.min(1, chambers.chamber3.vof_condensate[idx] + condensation_rate * params.dt);
              next.chamber3.oilConcentration[idx] = oil_conc * (1 + condensation_rate);
            }
            if (i < 8) {
              var neighborIdx = Math.floor(chamber2_nx * 0.9) + j * chamber2_nx;
              var steam_input = chambers.chamber2.vof_steam[neighborIdx] || 0;
              next.chamber3.vof_vapor[idx] = Math.min(0.95, vapor_vof + steam_input * params.dt * 0.1);
              next.chamber3.oilConcentration[idx] = Math.min(0.3, oil_conc + steam_input * 0.05 * params.dt);
            }
            if (i > chamber3_nx * 0.75) {
              next.chamber3.velocityU[idx] = 2.0;
              next.chamber3.extractionRate[idx] = oil_conc * next.chamber3.velocityU[idx];
            }
            next.chamber3.pressure[idx] = params.suctionPressure + (101325 - params.suctionPressure) * (i / chamber3_nx);
          }
        }

        var totals = {
          oil: 0,
          water: 0,
          vapor: 0,
          extract: 0
        };

        var len1 = chamber1_nx * chamber1_ny;
        var len2 = chamber2_nx * chamber2_ny;
        var len3 = chamber3_nx * chamber3_ny;

        for (i = 0; i < len1; i++) {
          totals.oil += next.chamber1.vof_oil[i];
        }
        for (i = 0; i < len2; i++) {
          totals.water += next.chamber2.vof_water[i];
        }
        for (i = 0; i < len3; i++) {
          totals.vapor += next.chamber3.vof_vapor[i];
          totals.extract += next.chamber3.extractionRate[i];
        }

        state.flowRates = {
          oil: totals.oil / len1,
          water: totals.water / len2,
          vapor: totals.vapor / len3,
          extract: totals.extract / len3
        };

        state.chambers = next;
        state.time += params.dt;
      }

      function squareToDisk(u, v) {
        var a = 2 * u - 1;
        var b = 2 * v - 1;
        if (a === 0 && b === 0) {
          return { x: 0, y: 0 };
        }
        var r;
        var theta;
        if (Math.abs(a) > Math.abs(b)) {
          r = a;
          theta = (Math.PI / 4) * (b / a);
        } else {
          r = b;
          theta = (Math.PI / 2) - (Math.PI / 4) * (a / b);
        }
        return {
          x: r * Math.cos(theta),
          y: r * Math.sin(theta)
        };
      }

      function lerp(a, b, t) {
        return a + (b - a) * t;
      }

      function drawConnector(start, end, color) {
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 8;
        ctx.globalAlpha = 0.4;
        ctx.beginPath();
        ctx.moveTo(start.x, start.y);
        var cp1 = { x: lerp(start.x, end.x, 0.35), y: start.y - 90 };
        var cp2 = { x: lerp(start.x, end.x, 0.65), y: end.y + 90 };
        ctx.bezierCurveTo(cp1.x, cp1.y, cp2.x, cp2.y, end.x, end.y);
        ctx.stroke();
        ctx.lineWidth = 3;
        ctx.globalAlpha = 0.9;
        ctx.strokeStyle = '#bae6fd';
        ctx.beginPath();
        ctx.moveTo(start.x, start.y);
        ctx.bezierCurveTo(cp1.x, cp1.y, cp2.x, cp2.y, end.x, end.y);
        ctx.stroke();
        ctx.restore();
      }

      function renderChamber(snapshot, layout) {
        var chamber = snapshot[layout.key];
        var nx = chamber.nx;
        var ny = chamber.ny;
        var radius = layout.radius;
        var centerX = layout.center.x;
        var centerY = layout.center.y;
        var cellRadius = radius / Math.max(nx, ny) * 1.4;
        var i, j, idx, u, v, pos, r, g, b, alpha;

        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius + 12, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(15, 23, 42, 0.65)';
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(148, 163, 184, 0.35)';
        ctx.stroke();
        ctx.clip();

        for (j = 0; j < ny; j++) {
          for (i = 0; i < nx; i++) {
            idx = i + j * nx;
            u = (i + 0.5) / nx;
            v = (j + 0.5) / ny;
            pos = squareToDisk(u, v);
            var px = centerX + pos.x * radius * 0.95;
            var py = centerY + pos.y * radius * 0.95;

            if (layout.key === 'chamber1') {
              var T = chamber.temperature[idx];
              var oil = chamber.vof_oil[idx];
              var vapor = chamber.vof_vapor[idx];
              if (oil > 0.5) {
                var tempNorm = Math.min(1, Math.max(0, (T - 350) / 100));
                r = Math.min(255, 100 + tempNorm * 155);
                g = Math.min(100, tempNorm * 50);
                b = 0;
              } else {
                r = Math.min(255, 200 + vapor * 55);
                g = Math.min(255, 150 + vapor * 105);
                b = Math.min(120, vapor * 120);
              }
              alpha = 0.78;
            } else if (layout.key === 'chamber2') {
              var water = chamber.vof_water[idx];
              var oil2 = chamber.vof_oil[idx];
              var steam = chamber.vof_steam[idx];
              var interfaceVal = chamber.interface_oil_water[idx];
              if (interfaceVal > 0.5) {
                r = 255;
                g = 255;
                b = 150;
                alpha = 0.92;
              } else if (water > 0.5) {
                r = 50;
                g = 150;
                b = Math.min(255, 220 + water * 55);
                alpha = 0.82;
              } else if (oil2 > 0.3) {
                r = Math.min(255, 150 + oil2 * 105);
                g = Math.min(150, oil2 * 100);
                b = 0;
                alpha = 0.78;
              } else {
                r = Math.min(255, 180 + steam * 75);
                g = Math.min(255, 200 + steam * 55);
                b = 255;
                alpha = 0.78;
              }
            } else {
              var vapor3 = chamber.vof_vapor[idx];
              var condensate = chamber.vof_condensate[idx];
              var extraction = chamber.extractionRate[idx];
              var oilConc = chamber.oilConcentration[idx];
              if (extraction > 0.1) {
                r = Math.min(255, 200 + extraction * 220);
                g = 255;
                b = Math.min(220, extraction * 800);
                alpha = 0.9;
              } else if (condensate > 0.5) {
                r = Math.min(255, 150 + oilConc * 400);
                g = Math.min(220, 110 + oilConc * 280);
                b = Math.min(255, 200 - oilConc * 220);
                alpha = 0.86;
              } else {
                r = Math.min(255, 150 + vapor3 * 50);
                g = Math.min(255, 180 + vapor3 * 30);
                b = Math.min(255, 200 + vapor3 * 55);
                alpha = 0.82;
              }
            }

            ctx.fillStyle = 'rgba(' + Math.round(r) + ', ' + Math.round(g) + ', ' + Math.round(b) + ', ' + alpha.toFixed(2) + ')';
            ctx.beginPath();
            ctx.arc(px, py, cellRadius, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        ctx.restore();
        ctx.save();
        ctx.fillStyle = 'rgba(226, 232, 240, 0.8)';
        ctx.font = '600 14px "Inter", "Segoe UI", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(layout.label, centerX, centerY + radius + 28);
        ctx.restore();
      }

      function render() {
        if (!state.chambers) {
          return;
        }
        var dpr = window.devicePixelRatio || 1;
        var rect = canvas.getBoundingClientRect();
        var width = rect.width || canvas.width;
        var height = rect.height || canvas.height;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, width, height);

        var layout = [
          { key: 'chamber1', center: { x: width * 0.26, y: height * 0.62 }, radius: Math.min(width, height) * 0.24, label: 'Chamber I ¬∑ Oil Heating' },
          { key: 'chamber2', center: { x: width * 0.52, y: height * 0.4 }, radius: Math.min(width, height) * 0.27, label: 'Chamber II ¬∑ Water Percolation' },
          { key: 'chamber3', center: { x: width * 0.78, y: height * 0.58 }, radius: Math.min(width, height) * 0.22, label: 'Chamber III ¬∑ Vapor Separation' }
        ];

        drawConnector(layout[0].center, layout[1].center, 'rgba(56, 189, 248, 0.6)');
        drawConnector(layout[1].center, layout[2].center, 'rgba(250, 204, 21, 0.6)');

        drawChamber(state.chambers, layout[0]);
        drawChamber(state.chambers, layout[1]);
        drawChamber(state.chambers, layout[2]);
      }

      function updateHud() {
        timePill.textContent = '‚è±Ô∏è Time ' + state.time.toFixed(3) + '\u00a0s';
        tempPill.textContent = 'üå°Ô∏è Oil Bath ' + params.inputTemp.toFixed(0) + '\u00a0K';
        waterPill.textContent = 'üíß Water Bath ' + params.waterTemp.toFixed(0) + '\u00a0K';
        pressurePill.textContent = 'üåÄ Suction ' + (params.suctionPressure / 1000).toFixed(0) + '\u00a0kPa';

        metricOil.textContent = state.flowRates.oil.toFixed(2);
        metricWater.textContent = state.flowRates.water.toFixed(2);
        metricVapor.textContent = state.flowRates.vapor.toFixed(2);
        metricExtract.textContent = state.flowRates.extract.toFixed(3);
      }

      function showError(message) {
        state.error = message;
        errorEl.style.display = 'block';
        errorEl.textContent = message;
      }

      function clearError() {
        state.error = null;
        errorEl.style.display = 'none';
      }

      function stepAndRender() {
        try {
          updateSimulation();
          render();
          updateHud();
        } catch (err) {
          stopSimulation();
          showError('Simulation halted: ' + err.message);
        }
      }

      function startSimulation() {
        if (state.running) {
          return;
        }
        state.running = true;
        clearError();
        statusText.textContent = 'Status: running';
        runBtn.textContent = '‚è∏Ô∏è Pause';
        state.tickHandle = setInterval(stepAndRender, 100);
      }

      function stopSimulation() {
        if (!state.running) {
          return;
        }
        state.running = false;
        statusText.textContent = 'Status: paused';
        runBtn.textContent = '‚ñ∂Ô∏è Run';
        if (state.tickHandle) {
          clearInterval(state.tickHandle);
          state.tickHandle = null;
        }
      }

      function resetSimulation() {
        stopSimulation();
        state.chambers = createInitialChambers();
        state.flowRates = { oil: 0, water: 0, vapor: 0, extract: 0 };
        state.time = 0;
        statusText.textContent = 'Status: idle';
        clearError();
        render();
        updateHud();
      }

      runBtn.addEventListener('click', function () {
        if (state.running) {
          stopSimulation();
        } else {
          startSimulation();
        }
      });

      resetBtn.addEventListener('click', function () {
        resetSimulation();
      });

      window.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          stopSimulation();
        }
      });

      window.addEventListener('resize', function () {
        render();
      });

      resetSimulation();
    })();
  </script>
</body>
</html>
